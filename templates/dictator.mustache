{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template mod_coreiframetest/dictator

    TODO describe template dictator

    Example context (json):
    {
    }
}}
<div class="cift_audiorecorder">
    <button type="button" class="btn btn-primary cift_audio_btn" aria-pressed="false">
        <i class="cift_buttonicon fa fa-microphone" aria-hidden="true"></i>
        <span class="cift_btnlabel ms-2">Record Audio</span>
    </button>
    <button type="button" class="btn btn-primary cift_video_btn" aria-pressed="false">
        <i class="cift_buttonicon fa fa-video-camera" aria-hidden="true"></i>
        <span class="cift_btnlabel ms-2">Record Video</span>
    </button>
</div>
<div class="cift_audioplayers">
</div>
{{^element.frozen}}
    {{#js}}
        require(['jquery', 'core/log'], function($, log) {
            $(function() {
                var $audioBtn = $('.cift_audio_btn');
                var $videoBtn = $('.cift_video_btn');
                var $players = $('.cift_audioplayers');

                var mediaRecorder = null;
                var chunks = [];
                var stream = null;
                var isRecording = false;

                function pickMimeType(type) {
                    var candidates = type === 'audio' ? [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/ogg;codecs=opus',
                        'audio/ogg'
                    ] : [
                        'video/webm;codecs=vp8,opus',
                        'video/webm',
                        'video/mp4'
                    ];
                    if (!window.MediaRecorder || typeof MediaRecorder.isTypeSupported !== 'function') {
                        return '';
                    }
                    for (var i = 0; i < candidates.length; i++) {
                        if (MediaRecorder.isTypeSupported(candidates[i])) {
                            return candidates[i];
                        }
                    }
                    return '';
                }

                function setBtnRecordingState($btn, recording) {
                    isRecording = recording;
                    if (recording) {
                        $btn.addClass('btn-danger').removeClass('btn-primary').attr('aria-pressed', 'true');
                        $btn.find('.cift_buttonicon').removeClass('fa-microphone fa-video-camera').addClass('fa-stop');
                        $btn.find('.cift_btnlabel').text('Stop');
                    } else {
                        $btn.addClass('btn-primary').removeClass('btn-danger').attr('aria-pressed', 'false');
                        $btn.find('.cift_buttonicon').removeClass('fa-stop').addClass($btn.hasClass('cift_audio_btn') ? 'fa-microphone' : 'fa-video-camera');
                        $btn.find('.cift_btnlabel').text($btn.hasClass('cift_audio_btn') ? 'Record Audio' : 'Record Video');
                    }
                }

                function addPlayerForBlob(blob, type) {
                    var url = URL.createObjectURL(blob);
                    var $wrapper = $('<div class="mt-3"></div>');
                    var $media = type === 'audio' ? $('<audio controls></audio>').attr('src', url) :
                        $('<video controls style="width: 80%; max-width: 300px"></video>').attr('src', url);
                    $wrapper.append($media);
                    $players.prepend($wrapper);
                }

                function stopStreamTracks() {
                    try {
                        if (stream) {
                            stream.getTracks().forEach(function(t) { t.stop(); });
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                function startRecording($btn, type) {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        $players.append('<div class="alert alert-warning mt-3">This browser does not support ' + type + ' recording.</div>');
                        return;
                    }
                    navigator.mediaDevices.getUserMedia(type === 'audio' ? { audio: true } : { video: true, audio: true }).then(function(s) {
                        stream = s;
                        chunks = [];
                        var options = {};
                        var mt = pickMimeType(type);
                        if (mt) { options.mimeType = mt; }
                        try {
                            mediaRecorder = new MediaRecorder(stream, options);
                        } catch (err) {
                            log.warn('Failed to create MediaRecorder, retrying without options: ' + err);
                            mediaRecorder = new MediaRecorder(stream);
                        }

                        mediaRecorder.ondataavailable = function(ev) {
                            if (ev && ev.data && ev.data.size > 0) {
                                chunks.push(ev.data);
                            }
                        };
                        mediaRecorder.onstop = function() {
                            var blob = new Blob(chunks, { type: mediaRecorder.mimeType || (type === 'audio' ? 'audio/webm' : 'video/webm') });
                            addPlayerForBlob(blob, type);
                            stopStreamTracks();
                            mediaRecorder = null;
                            setBtnRecordingState($btn, false);
                        };
                        mediaRecorder.start();
                        setBtnRecordingState($btn, true);
                    }).catch(function(err) {
                        log.error('getUserMedia error: ' + err);
                        $players.append('<div class="alert alert-danger mt-3">' + (type === 'audio' ? 'Microphone' : 'Camera or microphone') + ' permission denied or unavailable.</div>');
                        setBtnRecordingState($btn, false);
                    });
                }

                function stopRecording($btn) {
                    try {
                        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                            mediaRecorder.stop();
                        } else {
                            setBtnRecordingState($btn, false);
                            stopStreamTracks();
                        }
                    } catch (e) {
                        log.warn('Stop recording error: ' + e);
                        setBtnRecordingState($btn, false);
                        stopStreamTracks();
                    }
                }

                $audioBtn.on('click', function() {
                    if (isRecording) {
                        stopRecording($audioBtn);
                    } else {
                        startRecording($audioBtn, 'audio');
                    }
                });

                $videoBtn.on('click', function() {
                    if (isRecording) {
                        stopRecording($videoBtn);
                    } else {
                        startRecording($videoBtn, 'video');
                    }
                });
            });
        });
    {{/js}}
{{/element.frozen}}